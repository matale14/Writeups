# Lame

I began by running some Nmap scans, and I usually prefer to use </span><span class="c3"><a class="c4" href="https://www.google.com/url?q=https://github.com/rkhal101/nmapAutomator&amp;sa=D&amp;ust=1610798859691000&amp;usg=AOvVaw09fzKEMTk1muMPGiWP7lCu">https://github.com/rkhal101/nmapAutomator</a></span><span class="c0">&nbsp;to quickly run through important options.</span></p><p class="c1"><span class="c0">Since this was an easy box, I chose to do Recon at first to keep it quick. </span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 310.67px;"><img alt="" src="images/image8.png" style="width: 624.00px; height: 310.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">This showed 4 open ports.</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 315.00px; height: 37.00px;"><img alt="" src="images/image3.png" style="width: 315.00px; height: 37.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">We get the ftp version</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 193.33px;"><img alt="" src="images/image7.png" style="width: 624.00px; height: 193.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">Smbmap scan shows read, write access to tmp. My immediate thoughts are to upload a reverse shell there.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">After messing with my smbclient settings, I finally manage to connect,</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 324.00px;"><img alt="" src="images/image10.png" style="width: 624.00px; height: 324.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">Anonymous login is successful, but I get DC&rsquo;ed immediately.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">I don&rsquo;t want to hit my head against a wall unless I have no other option, luckily I have other ports to check as well.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">A searchsploit on the FTP version reveals an exploit:</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 100.00px;"><img alt="" src="images/image2.png" style="width: 624.00px; height: 100.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">This is a ruby script meant to work with the Metasploit framework. This makes it easy to implement and use. Unfortunately, using Metasploit will not teach how the backdoor works. So I will attempt to recreate it in python.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">The references I am using are:</span></p><p class="c1"><span class="c3"><a class="c4" href="https://www.google.com/url?q=https://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html&amp;sa=D&amp;ust=1610798859696000&amp;usg=AOvVaw0z9VKkQ7BjHj5deORd28FE">https://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html</a></span><span class="c0">&nbsp;</span></p><p class="c1"><span class="c0">A short explanation of the exploit</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c3"><a class="c4" href="https://www.google.com/url?q=https://pastebin.com/AetT9sS5&amp;sa=D&amp;ust=1610798859696000&amp;usg=AOvVaw33UdSYQ4DFuzCs1hYYdVfv">https://pastebin.com/AetT9sS5</a></span></p><p class="c1"><span class="c0">The source code in order to reverse engineer it.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c3"><a class="c4" href="https://www.google.com/url?q=https://github.com/offensive-security/exploitdb/blob/master/exploits/unix/remote/17491.rb&amp;sa=D&amp;ust=1610798859697000&amp;usg=AOvVaw0GsUybCZidaqgtgdM24YwE">https://github.com/offensive-security/exploitdb/blob/master/exploits/unix/remote/17491.rb</a></span></p><p class="c1"><span class="c0">The Metasploit exploit.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">Essentially the backdoor responds to a &ldquo;:)&rdquo; sent as the login value and will attempt to create a callback TCP shell on port 6200.</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 637.33px;"><img alt="" src="images/image12.png" style="width: 624.00px; height: 637.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">This was the script I created, it would connect to the FTP server, send the information, and connect to the backdoor. Unfortunately, it did not work.</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 378.00px; height: 137.00px;"><img alt="" src="images/image5.png" style="width: 378.00px; height: 137.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span>So to make sure it wasn&rsquo;t just my bad programming skills, I checked with Metasploit as well.</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 584.00px; height: 551.00px;"><img alt="" src="images/image6.png" style="width: 584.00px; height: 551.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">And it&rsquo;s a bust. Positives are more experience making my own exploits and familiarizing myself with python connections.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">So I guess it&rsquo;s back to the smbclient to see if we can get that to work.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 136.00px;"><img alt="" src="images/image11.png" style="width: 624.00px; height: 136.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">Some more exploits.</span></p><p class="c1"><span class="c0">This exploit uses the non-default &quot;username map script&quot; configuration option. By specifying a username containing shell meta characters, attackers can execute arbitrary commands.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">I generated the payload with Metasploit:</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 194.67px;"><img alt="" src="images/image4.png" style="width: 624.00px; height: 194.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">Using msfvenom to create a payload. -p tells the program to find a payload, specified after. Set the lhost and lport, we specify it to be used with python with -f python, which makes it easy to paste into our code.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">Then created an easy SMBConnection in python, using the Metasploit script as a base:</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 540.00px; height: 369.00px;"><img alt="" src="images/image1.png" style="width: 540.00px; height: 369.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c0">And I gained root access immediately.</span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 392.00px; height: 120.00px;"><img alt="" src="images/image9.png" style="width: 392.00px; height: 120.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span>Rlwrap is a readline wrap found here: </span><span class="c3"><a class="c4" href="https://www.google.com/url?q=https://github.com/hanslub42/rlwrap&amp;sa=D&amp;ust=1610798859700000&amp;usg=AOvVaw3faDt19JwLI3uKEVDiXJWw">https://github.com/hanslub42/rlwrap</a></span><span class="c0">&nbsp;Sometimes it is unnecessary, but I almost always add it just in case.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">Looking back on it, I should have done Searchsploit on both of the services at the beginning. I think it&rsquo;s generally better to start super wide, and then close in. So start with using Nmap to see what services are running, check if any of those services have vulnerabilities. Then see which vulnerabilities are worth checking out. In this case, I could have been done a lot quicker by just using the Metasploit scripts already created, but I really want to create them manually from now on, as I think I learn a lot more that way.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">In this box, the foothold also meant root, so there was no real privilege escalation, as that happened automatically.</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1">

## Comparing to the official writeup:

They reach the same conclusion, in that after checking out the vsftpd exploit, the only remaining solution is the samba exploit. They chose to run metasploit which makes the whole process extremely trivial.

## How to stop this exploit:

Update to the most recent version of vsftpd. As the exploit is only related to version 2.3.4
